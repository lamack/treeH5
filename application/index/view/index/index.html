<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>欢乐植树</title>
    <link rel="stylesheet" type="text/css" href="{$static_dir}home/css/reset.css">
    <link rel="stylesheet" type="text/css" href="{$static_dir}home/css/index.css">
    <style type="text/css">
    body {}
    </style>
</head>

<body>
    <div class="container">
        <div class="blur_container hei">
            <div class="blur_bg"></div>
            <div class="blur_box none">
                <div class="item_row flex flex-justify-arround">
                    <div class="">
                        <div class="jingling green_png"></div>
                        <p class="">{$_MEMBER.green_max|default=0}</p>
                    </div>
                    <div class="">
                        <div class="jingling duihuan_png"></div>
                        <p class="">{$_MEMBER.green|default=0}</p>
                    </div>
                    <div class="">
                        <div class="jingling budui_png"></div>
                        <p class="">{$_MEMBER.green_nocash|default=0}</p>
                    </div>
                    <div class="item-cash">
                        <div class="jingling hsf2_png"></div>
                        <p class="">{$_MEMBER.share|default=0}</p>
                    </div>
                    <div class="">
                        <div class="jingling bigtree_png"></div>
                        <p class="">{$count|default=1}</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="bomb daoju-bomb">
            <div class="bomb-po">
                <div class="title">道具使用</div>
                <div class="close"></div>
                <div class="bomb-box">
                    <div class="middle clearfix">
                        请选择使用或者兑换工具
                    </div>
                    <div class="bottom">
                        <div class="status">
                            <div class="use btn">使用</div>
                            <div class="exchange btn">兑换</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="bomb bomb-dialog">
           <div class="bomb-po">
               <div class="title">温馨提示</div>
               <div class="close"></div>
               <div class="bomb-box">
                   <div class="middle clearfix">
                       请先去兑换工具
                   </div>
                   <div class="bottom">
                       <div class="status">
                           <div class="use btn">确定</div>
                           <div class="exchange btn">取消</div>
                       </div>
                   </div>
               </div>
           </div>
        </div>
        <div class="bomb guoshi-bomb">
            <div class="bomb-po">
                <div class="title">温馨提示</div>
                <div class="close"></div>
                <div class="bomb-box">
                    <div class="middle clearfix">
                    </div>
                    <div class="bottom">
                        <div class="status">
                            <div class="btn">确定</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="bomb hudun-bomb">
            <div class="bomb-po">
                <div class="title">温馨提示</div>
                <div class="close"></div>
                <div class="bomb-box">
                    <div class="middle clearfix">
                        是否需要兑换护盾？
                    </div>
                    <div class="bottom">
                        <div class="status">
                            <div class="use btn">兑换</div>
                            <div class="exchange btn">取消</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="tree">
            <div class="gethudun"><img src="{$static_dir}home/img/hudun1.png" /></div>
            <div class="old tree-box"><img src="{$static_dir}home/img/oldtree.png"></div>
            <div class="grow tree-box"><img src="{$static_dir}home/img/growtree.png"></div>
            <div class="child tree-box"><img src="{$static_dir}home/img/childtree.png"></div>
            <div class="tree-box active"></div>
            <!-- <div class="qipao">
                <div class="life-num">80</div>
                <div class="chengzhang">成长值</div>
                <div class="add move">+10</div>
                <div class="minus move">-10</div>
            </div> -->
        </div>
        <div class="blur_container col">
            <div class="blur_bg"></div>
            <div class="blur_box flex flex-col flex-justify-arround">
                <div class="item_col flex-1">
                    <a href="{:url('Adv/index',['token'=>$_TOKEN_])}" class="flex flex-align">
                        <div class="center">
                            <div class="jingling notice_png"></div> 公告
                        </div>
                    </a>
                </div>
                <div class="item_col flex-1">
                    <a href="{:url('TreesMap/index',['token'=>$_TOKEN_])}" class="flex flex-align">
                        <div class="center">
                            <div class="jingling mapicon_png"></div> 森林
                        </div>
                    </a>
                </div>
                <div class="item_col flex-1">
                    <a href="{:url('Task/index',['token'=>$_TOKEN_])}" class="flex flex-align">
                        <div class="center">
                            <div class="jingling taskicon_png"></div> 奖励
                        </div>
                    </a>
                </div>
                <div class="item_col flex-1">
                    <a href="{:url('Rank/index',['token'=>$_TOKEN_])}" class="flex flex-align">
                        <div class="center">
                            <img src="{$static_dir}home/img/rank.png"> 排行榜
                        </div>
                    </a>
                </div>
            </div>
        </div>
        <div class="planting flex">
            <div class="planting-item flex-1 flex flex-justify-arround flex-align">
                <div class="item watering">
                    <div class="water act">
                        <img src="{$static_dir}home/img/water.png" class="water1">
                        <img src="{$static_dir}home/img/water2.png" class="water2">
                    </div>
                    <img src="{$static_dir}home/img/water.png"> x
                    <span class="num">{$waterprop|default=0}</span>
                    <div class="add1 one">+1</div>
                    <div class="minus1 one">-1</div>
                </div>
                <div class="item cutting">
                    <div class="cut act">
                        <img src="{$static_dir}home/img/cut.png" class="cut1">
                        <img src="{$static_dir}home/img/cut2.png" class="cut2">
                    </div>
                    <img src="{$static_dir}home/img/cut.png"> x
                    <span class="num">{$cutprop|default=0}</span>
                    <div class="add1 one">+1</div>
                    <div class="minus1 one">-1</div>
                </div>
                <div class="item feeding">
                    <div class="shifei act">
                        <img src="{$static_dir}home/img/shifei.png" class="shifei1">
                        <img src="{$static_dir}home/img/shifei1.png" class="shifei2">
                    </div>
                    <img src="{$static_dir}home/img/shifei.png"> x
                    <span class="num">{$shifeiprop|default=0}</span>
                    <div class="add1 one">+1</div>
                    <div class="minus1 one">-1</div>
                </div>
                <div class="item defense">
                    <img src="{$static_dir}home/img/hudun.png" class="hudun act">
                    <img src="{$static_dir}home/img/hudun.png"> x
                    <span class="num">{$hudunprop|default=0}</span>
                    <div class="add1 one">+1</div>
                    <div class="minus1 one">-1</div>
                </div>
            </div>
        </div>
        
        <!-- <div class="hsf">
            <a href="javascript:;" class="">
                <div class="jingling hsf1_png "></div>
                红色寻访
         </a>
        </div> -->
        <div class="me">
            <a href="{:url('Me/index',['token'=>$_TOKEN_])}" class="">
                <div class="jingling self_png"></div>
                <!-- <p>{$_MEMBER.username}</p> -->
         </a>
        </div>
        <div class="disaster">
            <div class="hongshui">
                <img src="{$static_dir}home/img/hongshui1.png">
                <div class="inline"></div>
                <img src="{$static_dir}home/img/hongshui2.png">
            </div>
            <div class="cloud">
                <img src="{$static_dir}home/img/cloud.png">
            </div>
            <div class="ganhan"></div>
            <div class="taifeng">
                <img src="{$static_dir}home/img/taifeng.png">
            </div>
        </div>
        <div class="lunbo">
            <div class="lunbobg"></div>
            <div class="lunbobox">
                <div class="xx"><div class="x"><div class="x-move"><span id="marq"> </span></div></div></div>
            </div>
        </div>
    </div>
    <script type="text/javascript" src="{$static_dir}home/js/zepto.js"></script>
    <script type="text/javascript" src="{$static_dir}home/js/public.js"></script>
    <script type="text/javascript" src="{$static_dir}home/js/touch.js"></script>
    <!-- <script type="text/javascript" src="{$static_dir}home/js/index.js"></script> -->
    <script type="text/javascript">
    $(function() {
        var adv = JSON.parse('{$tips_adv|json_encode}');
        var lunboadv = JSON.parse('{$lunbo|json_encode}');

        var lstr = '';
        if(adv.length!=0||lunboadv.length!=0){
            for(var i=0;i<adv.length;i++){
                lstr+=adv[i]+'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
            }
            for(var i=0;i<lunboadv.length;i++){
                lstr+=lunboadv[i].adv_title+'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
            }
            $('.lunbobox').find('#marq').html(lstr);
            $('#marq').ready(function(){
                 $('.lunbo').show();
                 var w= document.querySelector('#marq').offsetWidth;
                 document.querySelector('.x').style.width = w+'px'
            })
        }
        console.log(adv,'44',lunboadv)
        document.addEventListener("touchmove", function (e) {
             $('.bomb').each(function(){
                if($(this).css('display')=='block'){
                    e.preventDefault();
                    e.stopPropagation();
                    return;
                }
            })
        }, false);
       
        $('.close', '.bomb').click(function() {
            $('.bomb').hide();
            $('.bomb-dialog').hide();
        })
        $('.exchange','.bomb-dialog').click(function(){
            $('.bomb-dialog').hide();
        })
        //操作+1和-1小图标
        var Handlecount = {
            els: $('.planting').find('.item'),
            init: function() {},
            add: function(index) {
                var that = this;
                this.els.eq(index).find('.add1').addClass('active');
                this.dom(index, 1);
                setTimeout(function() {
                    that.els.eq(index).find('.add1').removeClass('active');
                }, 1000)
            },
            minus: function(index) {
                var that = this;
                this.els.eq(index).find('.minus1').addClass('active')
                this.dom(index)
                setTimeout(function() {
                    that.els.eq(index).find('.minus1').removeClass('active')
                }, 1000)
            },
            dom: function(index, add) {
                var el = this.els.eq(index).find('.num');
                var num = parseInt(el.html());
                num = add ? (num + 1) : (num - 1);
                el.html(num)
            }
        }
        Handlecount.init();

        //轮播
        var Lunbo = {
            lunboCon: $('.lunbo-container'),
            lunbo: $('.lunbobox'),
            top: 30,
            hei: 0,
            init: function() {
            },
            isShow(starTime,type,callback){
                var that = this;
                var time = new Date().getTime();
                var dif = starTime-parseInt(time/1000);
                console.log(dif)
                // if(dif<3600 && dif>0){
                if(dif<600 && dif>0){    
                    var str = '';
                    switch(type){
                        case 0:
                        str = '分钟后将会有强烈台风来袭，请做好防护措施，护盾会自动弹出，能有效抵抗台风，保证树的安全！';
                        break;
                        case 1:
                        str = '分钟后将会有强烈洪水来袭，请做好防护措施，护盾会自动弹出，能有效抵抗洪水，保证树的安全！';
                        break;
                        case 2:
                        str = '分钟后将会有强烈干旱来袭，请做好防护措施，护盾会自动弹出，能有效抵抗干旱，保证树的安全！';
                        break;
                    };
                    that.lunbo.find('#marq').text(Math.ceil(dif/60)+str); 
                    var timer = setInterval(function(){
                        var timen = new Date().getTime();
                        var dif2 = parseInt((starTime-parseInt(timen/1000))/60);
                        if(dif2>0){
                            that.lunbo.find('#marq').text(dif2+str);
                        }else{
                            clearInterval(timer);
                            $('.lunbo').hide();
                            callback();
                            if($('.planting').find('.item').eq(3).find('.num').text()>0){
                                Disaster.hudun();
                            }
                            getData({
                                url: '/level',
                                success: function(ref) {
                                    var data = ref.data;
                                    console.log(data)
                                    var ind = 3;
                                    switch (data.list.level) {
                                        case 1:
                                            ind = 2;
                                            break;
                                        case 2:
                                            ind = 1;
                                            break;
                                        case 3:
                                            ind = 0;
                                            break;
                                    }
                                    if(ind!=treeindex){
                                        Tree.growing(ind,ind++)
                                        // Tree.now--
                                        // Tree.tools.find('.act').eq(Tree.index).removeClass('active')
                                    }
                                }
                            })
                        }
                    },60000)
                    $('#marq').ready(function(){
                         $('.lunbo').show();
                         var w= document.querySelector('#marq').offsetWidth;
                         document.querySelector('.x').style.width = w+'px'
                    })
                    // this.init();
                }
            },
        }

       


         //植树
        var treelevel = JSON.parse('{$tree|json_encode}');
        var treeindex = 3;
        var furit ;
        if(treelevel){
            furit = treelevel.furit;
            switch (treelevel.level) {
                case 1:
                    treeindex = 2;
                    break;
                case 2:
                    treeindex = 1;
                    break;
                case 3:
                    treeindex = 0;
                    break;
            }
        }
        var Guoshi = {
            furit:furit,
            el: $('.old', '.tree'),
            bomb:$('.guoshi-bomb'),
            init: function() {
                if(this.furit){
                    this.render();
                }
                this.bindEvent();
            },
            bindEvent() {
                var that =this;
                // 点击果实 掉接口
                this.el.find('.guoshi').click(function(event) {
                    var _this = this;
                    var type = $(this).data('type');
                    var data = {
                        url: '/furit?type=' + type,
                        success: function(ref) {
                            var datas = ref.data;
                            that.bomb.find('.middle').text(datas.msg)
                            that.bomb.show();
                            if (datas.status == 'error') {

                            } else {
                                var i = $(_this).index();
                                $(_this).hide();
                                var l = JSON.parse(localStorage.getItem('l'));
                                var t = JSON.parse(localStorage.getItem('t'));
                                if(i==0){
                                    l.shift()
                                    l.shift()
                                }else{
                                    l.pop()
                                    t.pop()
                                }
                                localStorage.setItem('l',JSON.stringify(l))
                                localStorage.setItem('t',JSON.stringify(t))
                            }
                        }
                    }
                    getData(data)
                })
                //关闭按钮
                this.bomb.find('.close').click(function(){
                    that.bomb.hide();
                })
                this.bomb.find('.btn').click(function(){
                    that.bomb.hide();
                })
            },
            getT() {
                return parseInt(17 + Math.random() * 25)
            },
            getL() {
                return parseInt(18 + Math.random() * 56)
            },
            render() {
                var l = localStorage.getItem('l') || '[]';
                var t = localStorage.getItem('t') || '[]';
                var l = JSON.parse(l);
                var t = JSON.parse(t);
                if(l.length==0){
                    for (var i = 0; i < this.furit.length; i++) {
                        l.push(this.getL());
                        t.push(this.getT());
                    }
                    localStorage.setItem('l',JSON.stringify(l))
                    localStorage.setItem('t',JSON.stringify(t))
                }
                var str = '';
                for (var i = 0; i < this.furit.length; i++) {
                    str += '<div style="top:' + t[i] + '%;left:' + l[i] + '%;" class="guoshi" data-type="'+this.furit[i].type+'"></div>'
                }
                
                this.el.append(str)
            }
        }
        Guoshi.init();
       
        var Tree = {
            tree: $('.tree').find('.tree-box'),
            tools: $('.planting').find('.item'),
            bomb: $('.daoju-bomb'),
            bombdialog :$('.bomb-dialog'),
            now: treeindex,
            next: null,
            index: 0,
            isClick:true,
            init: function() {
                this.tree.eq(this.now).addClass('active').siblings().removeClass('active')
                this.next = this.now - 1;
                this.bindEvent();
            },
            bindEvent: function() {
                var that = this;

                var disasterArr = '{$disaster|json_encode}';
                disasterArr = JSON.parse(disasterArr);
                //点击工具
                this.tools.click(function() { 
                    //灾难结束时才能使用道具
                    if(!that.isClick) return;
                    that.index = $(this).index();
                    // 如果点击盾牌
                    if ($(this).index() == 3){
                        $('.hudun-bomb').show();
                    }else{
                        //如果没有道具 显示兑换弹框
                        if ($('.planting').find('.item').eq(that.index).find('.num').text() == 0) {
                            $('.bomb-dialog').show();
                            return;
                        }
                        $('.daoju-bomb').show();
                    }
                });
                // 点击使用
                this.bomb.find('.use').click(function(event) {
                    var data = {
                        url: '/prop?prop_type=' + (that.index + 1),
                        success: function(ref) {
                            console.log(ref)
                            var data = ref.data;
                            if (data.status == 'error') {
                                that.bomb.hide();
                                $('.guoshi-bomb').find('.middle').text(data.msg)
                                $('.guoshi-bomb').show();
                            } else {
                                that.bomb.hide();
                                that.event(that.index);
                                setTimeout(function(){
                                    getData({
                                        url: '/level',
                                        success: function(ref) {
                                            var data = ref.data;
                                            console.log(data)
                                            if (data.status == 'succ') {
                                                var list = data.list;
                                                if (list.status == 1) {
                                                    $('.lunbo').show();
                                                } else if (list.status == 2) {
                                                    Guoshi.furit = data.furit;
                                                    Guoshi.init();
                                                }
                                            }
                                        }
                                    })
                                },4000)
                            }
                        }
                    }
                    getData(data)

                    // that.event(that.index);
                    // that.bomb.hide();
                    // //树苗成长
                    // setTimeout(function() {
                    //     that.growing(that.now, that.next)
                    //     that.now--;
                    //     that.tools.find('.act').eq(that.index).removeClass('active')
                    // }, 4000)
                    that.bomb.hide();

                });
                //点击兑换护盾
                $('.hudun-bomb').find('.use').click(function(){
                    that.getTreeData(that);
                     $('.hudun-bomb').hide();
                })
                $('.hudun-bomb').find('.exchange').click(function(){
                     $('.hudun-bomb').hide();
                })
                // 点击兑换
                this.bomb.find('.exchange').click(function(event) {
                     that.getTreeData(that);
                      that.bomb.hide();
                });
                this.bombdialog.find('.use').click(function(event) {
                     that.getTreeData(that);
                      that.bombdialog.hide();
                });
            },
            //植树效果
            event: function(i) {
                this.isClick = false;
                var that = this;
                this.tools.find('.act').eq(i).addClass('active')
                Handlecount.minus(i)
                setTimeout(function(){
                    that.tools.find('.act').eq(i).removeClass('active')
                    that.isClick = true;
                },4000)
            },
            growing: function(now, next) {
                var that = this;
                var heinow = this.tree.eq(now).height();
                var heinext = this.tree.eq(next).height();
                var per = heinext / heinow;
                this.tree.eq(now).css({
                    transform: 'scale(' + per + ',' + per + ')',
                    opacity: 0,
                })
                setTimeout(function() {
                    that.tree.eq(next).css({
                        opacity: 1,
                    })
                    if (next != 0) {
                        that.next--;
                    }
                }, 1000)
            },
            getTreeData: function(that) {
                // 兑换道具接口
                var data = {
                    url: '/cash?prop_type=' + (that.index + 1),
                    success: function(ref) {
                        console.log(ref)
                        var data = ref.data;
                        if (data.status == 'error') {
                            $('.bomb').hide();
                            $('.guoshi-bomb').find('.middle').text(data.msg)
                            $('.guoshi-bomb').show();
                        } else {
                            // 道具+1
                            Handlecount.add(that.index);
                             // 金币数
                             var cashNum = parseInt($('.item-cash p').text()) - data.data.cash;
                             if (cashNum < 0) {cashNum=0;}
                             $('.item-cash p').text(cashNum)
                            $('.bomb-dialog').hide();
                        }
                    }
                }
                getData(data);
            }
        }
        Tree.init();
        //灾难来袭
        var Disaster = {
            hongshui: $('.hongshui'),
            ganhan: $('.ganhan'),
            taifeng: $('.taifeng'),
            cloud: $('.cloud'),
            init: function(t) {
                //api
                var that = this;
                var baseUrl = "{:url('Index/prop')}";
                var disasterArr = '{$disaster|json_encode}';
                disasterArr = JSON.parse(disasterArr);
                if (disasterArr) {
                    console.log(disasterArr)
                    var isFlag = localStorage.getItem('isFlag_' + disasterArr.id);
                    var starTime = disasterArr.start_time;
                    switch (disasterArr.disaster_type) {
                        case 0:
                            Lunbo.isShow(starTime,0,that.taifengcom);
                            Lunbo.init();
                            break;
                        case 1:
                            Lunbo.isShow(starTime,1,that.hongshuicom);
                            Lunbo.init();
                            break;
                        case 2:
                            Lunbo.isShow(starTime,2,that.ganhancom);
                            Lunbo.init();
                            break;
                    }

                }

            },
            hongshuicom: function() {
                Tree.isClick = false;
                $('.hongshui').show();
                $('.cloud').show();
                setTimeout(function(){
                    Tree.isClick = true;
                    $('.hongshui').hide();
                    $('.cloud').hide();
                },4000)
                //this.hudun();
            },
            ganhancom: function() {
                Tree.isClick = false;
                var that = this;
                $('.ganhan').addClass('active')
                setTimeout(function(){
                    Tree.isClick = true;
                    $('.ganhan').removeClass('active')
                },8000)
            },
            taifengcom: function() {
                Tree.isClick = false;
                var that = this;
                $('.taifeng').addClass('active')
                // that.hudun();
                setTimeout(function() {
                    $('.taifeng').removeClass('active');
                    Tree.isClick = true;
                }, 8000)
            },
            hudun: function() {
                var that = this;
                //护盾激活效果
                $('.hudun').addClass('active')
                Handlecount.minus(3);
                //护盾运动效果
                $('.gethudun').addClass('active')
                //护盾效果结束
                setTimeout(function() {
                    $('.hudun').removeClass('active')
                    $('.gethudun').removeClass('active')
                    that.hongshui.hide();
                    that.cloud.hide();
                }, 4000)
            }
        }
        Disaster.init();
        
    })
    </script>
</body>

</html>